sudo: required
language: node_js
node_js:
    - "4"
    - "5"
    - "6"
services:
    - docker

before_install:
    - sudo wget -O- -q https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
    - sudo wget -q https://packages.microsoft.com/config/ubuntu/14.04/prod.list -O /etc/apt/sources.list.d/mssql-release.list
    - sudo apt-get update
    - sudo ACCEPT_EULA=Y apt-get install msodbcsql=13.1.9.2-1
    - sudo ACCEPT_EULA=Y apt-get install mssql-tools
    - sudo docker pull microsoft/mssql-server-linux:2017-CU7
    - sudo docker run -e 'ACCEPT_EULA=Y' -e 'SA_PASSWORD=P@s$w0rd' -e 'MSSQL_PID=Developer' --network host -p 1400:1433 --name sql1 -d microsoft/mssql-server-linux:2017-CU7
    - sudo docker ps -a
    - sudo docker exec -it sql1 bash -c "echo -e 'create database brutedb;\ngo\nuse brutedb;\ngo\ncreate schema bruteschema;\ngo\ncreate table bruteschema.brute(id nvarchar(255) primary key, count int, first_request datetime2, last_request datetime2, expires datetime2);\ngo' > script.sql"
    - sudo docker exec -it sql1 bash -c "echo -e '#!/usr/bin/env bash\n\n# this seems to help (eyeroll)\nsleep 10\n\necho 'Creating database'\n\nimport_data() {\n    /opt/mssql-tools/bin/sqlcmd -S 127.0.0.1 -U sa -P 'P@s$w0rd' -d brutedb -i script.sql\n}\n\nimport_data || (sleep 5 && import_data)' > script.sh"
    - sudo docker exec -it sql1 sh script.sh
